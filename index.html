<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星穹铁道配队计算器 (Web版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="./style/style.css">
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="panel-header">
            <h2>流萤配速</h2>
            <div class="header-btns">
                <button class="btn-primary" onclick="calculate()">刷新</button>
                <button class="btn-primary" onclick="exportImage()" style="background-color:#10b981">存图</button>
            </div>
        </div>

        <div class="controls-row">
            <div class="control-group">
                <span class="info-label">动数:</span>
                <label><input type="checkbox" name="target_moves" value="4" checked onchange="calculate()">4</label>
                <label><input type="checkbox" name="target_moves" value="5" checked onchange="calculate()">5</label>
                <label><input type="checkbox" name="target_moves" value="6" onchange="calculate()">6</label>
                <label><input type="checkbox" name="target_moves" value="7" onchange="calculate()">7</label>
                <label><input type="checkbox" name="target_moves" value="8" onchange="calculate()">8</label>
            </div>
            
            <div class="control-group">
                <span class="info-label">速度:</span>
                <input type="number" id="min_spd" value="100" onchange="calculate(this)"> 
                <span>-</span>
                <input type="number" id="max_spd" value="300" onchange="calculate(this)">
            </div>

            <div class="control-group">
                <span class="info-label">金数:</span>
                <input type="number" id="min_cost" value="0" onchange="calculate(this)"> 
                <span>-</span>
                <input type="number" id="max_cost" value="11" onchange="calculate(this)">
            </div>
        </div>
    </div>

    <div class="panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h4 style="margin:0">角色选择</h4>
            <div style="font-size:12px;">
                <a href="javascript:void(0)" onclick="toggleAll(true)">全选</a> / 
                <a href="javascript:void(0)" onclick="toggleAll(false)">清空</a>
            </div>
        </div>
        
        <div id="char-grid" class="char-grid">
            </div>
    </div>

    <div id="capture-wrapper" style="overflow-x: auto;">
        <div id="capture-area">
            <h3 style="margin: 0 0 10px 10px;">计算结果</h3>
            <div id="results-area">
                </div>
        </div>
    </div>
</div>

<script>
    // --- 1. 配置数据 ---
    const CONSTANTS = {
        FIREFLY_BASE_SPD: 104.0,
        FIREFLY_ULT_FLAT: 60.0,
        SUMMON_SPEED: 70.0,
    };

    const CANDIDATES_DATA = {
        "大丽花":       { spd_pct: 0.30, advance: 0.00, base: "dahlia", cost: 1, img: "avatars/dahlia.jpg", times: 1 },
        "6魂大丽花":    { spd_pct: 0.30, advance: 0.20, base: "dahlia", cost: 7, img: "avatars/dahlia6.jpg", times: 1 },
        "忘归人":       { spd_pct: 0.00, advance: 0.00, base: "wang", cost: 1,   img: "avatars/wang.jpg", times: 1 },
        "2魂忘归人":    { spd_pct: 0.00, advance: 0.24, base: "wang", cost: 3,   img: "avatars/wang2.jpg", times: 1 },
        "阮·梅":        { spd_pct: 0.10, advance: 0.00, base: "ruan", cost: 0,   img: "avatars/ruan.jpg", times: 1 },
        "开拓者(555)":  { spd_pct: 0.00, advance: 0.24, base: "kaituozhe", cost: 0, img: "avatars/aki.jpg", times: 1 },
        "开拓者":       { spd_pct: 0.00, advance: 0.00, base: "kaituozhe", cost: 0, img: "avatars/aki.jpg", times: 1 },
        "加拉赫/灵砂":  { spd_pct: 0.00, advance: 0.00, base: "heel", cost: 0,      img: "avatars/lingsha.jpg", times: 1 },
    };

    let conditionData = {
        'minSpd': 100,
        'maxSpd': 300,
        'minCost': 0,
        'maxCost': 11,
    }

    let selectedCandidates = new Set(Object.keys(CANDIDATES_DATA));
    let candidateTimes = {};

    // --- 2. 初始化 ---
    function initUI() {
        const grid = document.getElementById('char-grid');
        grid.innerHTML = '';

        for (const [name, data] of Object.entries(CANDIDATES_DATA)) {
            candidateTimes[name] = data.times;

            const card = document.createElement('div');
            card.className = `char-card ${selectedCandidates.has(name) ? 'selected' : ''}`;
            card.dataset.name = name;
            
            // 点击事件：如果是点击输入框，阻止冒泡
            card.onclick = (e) => {
                if(e.target.tagName === 'INPUT') return;
                toggleCandidate(name, card);
            };

            const firstChar = name.charAt(0);
            
            // 图片逻辑：优先显示图片，失败显示文字
            // 默认用文字占位，你有图片请取消下方 img 注释
            let imgHtml = `<img src="${data.img}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"> <span style="display:none">${firstChar}</span>`;
            // let imgHtml = `<span>${firstChar}</span>`; 

            card.innerHTML = `
                <div class="char-img-box">${imgHtml}</div>
                <div class="char-name">${name}</div>
                <div class="times-control">
                    × <input type="number" class="times-input" value="${candidateTimes[name]}" 
                      onchange="updateTimes('${name}', this.value)" min="1" max="10">
                </div>
            `;
            grid.appendChild(card);
        }
        calculate();
    }

    function toggleCandidate(name, cardElement) {
        if (selectedCandidates.has(name)) {
            selectedCandidates.delete(name);
            cardElement.classList.remove('selected');
        } else {
            selectedCandidates.add(name);
            cardElement.classList.add('selected');
        }
        calculate();
    }

    function toggleAll(selectAll) {
        const cards = document.querySelectorAll('.char-card');
        cards.forEach(card => {
            const name = card.dataset.name;
            if (selectAll) {
                selectedCandidates.add(name);
                card.classList.add('selected');
            } else {
                selectedCandidates.delete(name);
                card.classList.remove('selected');
            }
        });
        calculate();
    }

    function updateTimes(name, value) {
        candidateTimes[name] = parseInt(value) || 1;
        calculate();
    }

    // --- 3. 计算核心 ---
    function getCombinations(arr, k) {
        let i, subI, ret = [], sub, next;
        for (i = 0; i < arr.length; i++) {
            if (k === 1) {
                ret.push([arr[i]]);
            } else {
                sub = getCombinations(arr.slice(i + 1), k - 1);
                for (subI = 0; subI < sub.length; subI++) {
                    next = sub[subI];
                    next.unshift(arr[i]);
                    ret.push(next);
                }
            }
        }
        return ret;
    }

    function calculate(el=NaN) {
        const resultsArea = document.getElementById('results-area');
        resultsArea.innerHTML = '';

        // 1. 获取过滤条件并做约束（防止输入负数或 max < min）
        let minSpd = parseFloat(document.getElementById('min_spd').value);
        let maxSpd = parseFloat(document.getElementById('max_spd').value);
        let minCost = parseInt(document.getElementById('min_cost').value);
        let maxCost = parseInt(document.getElementById('max_cost').value);

        if (el && el.id === 'min_spd' && minSpd >= maxSpd) {
            minSpd = conditionData.maxSpd - 1;
            minSpd.value = minSpd;
        }
        // 如果用户修改的是“最大速度”，且输入值小于了最小值 -> 强行把最大值推回(Clamp)到最小值
        else if (el && el.id === 'max_spd' && maxSpd <= minSpd) {
            maxSpd = conditionData.minSpd + 1;
            maxSpd.value = maxSpd;
        } 
        // 防止负数的基础校验
        minSpd = Math.max(0, minSpd);
        maxSpd = Math.max(0, maxSpd);

        if (el && el.id === 'min_cost' && minCost >= maxCost) {
            minCost = conditionData.maxCost - 1;
            minCost.value = minCost;
        }
        else if (el && el.id === 'max_cost' && maxCost <= minCost) {
            maxCost = conditionData.minCost + 1;
            maxCost.value = maxCost;
        }
        // 防止负数
        minCost = Math.max(0, minCost);
        maxCost = Math.max(0, maxCost);

        // 将修正后的值回写到输入框，保证 UI 与内部一致
        document.getElementById('min_spd').value = Math.round(minSpd);
        document.getElementById('max_spd').value = Math.round(maxSpd);
        document.getElementById('min_cost').value = Math.round(minCost);
        document.getElementById('max_cost').value = Math.round(maxCost);

        // 确保内部数据一致
        conditionData = { minSpd, maxSpd, minCost, maxCost };
        
        const targetMoves = [];
        document.querySelectorAll('input[name="target_moves"]:checked').forEach(el => targetMoves.push(parseInt(el.value)));

        const activeCandidatesList = Array.from(selectedCandidates);
        const combinations = getCombinations(activeCandidatesList, 3);
        const validResults = [];

        combinations.forEach(team => {
            const bases = team.map(name => CANDIDATES_DATA[name].base);
            const uniqueBases = new Set(bases);
            if (uniqueBases.size !== bases.length) return;

            let totalAdvance = 0, totalSpdPct = 0, totalCost = 0;

            team.forEach(name => {
                const d = CANDIDATES_DATA[name];
                const times = candidateTimes[name];
                totalAdvance += d.advance * times;
                totalSpdPct += d.spd_pct;
                totalCost += d.cost;
            });

            targetMoves.forEach(moves => {
                const countdownAv = 10000.0 / CONSTANTS.SUMMON_SPEED;
                const intervals = moves - 1;
                const totalDistance = (10000.0 * intervals) - (10000.0 * totalAdvance);
                const reqIngameSpeed = totalDistance / countdownAv;
                const reqPanelSpeed = reqIngameSpeed - CONSTANTS.FIREFLY_ULT_FLAT - (CONSTANTS.FIREFLY_BASE_SPD * totalSpdPct);
                const displaySpeed = Math.max(0, reqPanelSpeed, CONSTANTS.FIREFLY_BASE_SPD);

                if (displaySpeed >= minSpd && displaySpeed <= maxSpd && totalCost >= minCost && totalCost <= maxCost) {
                    validResults.push({ team, moves, speed: displaySpeed, cost: totalCost, spdPct: totalSpdPct, advancePct: totalAdvance });
                }
            });
        });

        validResults.sort((a, b) => b.cost - a.cost);

        if (validResults.length === 0) {
            resultsArea.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">无符合条件的结果</div>';
            return;
        }

        validResults.forEach(r => {
            const row = document.createElement('div');
            row.className = 'result-row';

            let avatarsHtml = '';
            r.team.forEach(name => {
                const d = CANDIDATES_DATA[name];
                const times = candidateTimes[name];
                
                let costBadge = d.cost > 1 ? `<div class="dot dot-cost">${d.cost - 1}</div>` : '';
                let wuwuwuBadge = name.includes('555') ? `<div class="dot dot-555">5</div>` : '';
                let timesBadge = times > 1 ? `<div class="dot dot-times">${times}</div>` : '';
                
                // 图片显示：有图片显示图片，无图片显示首字
                let imgContent = `<img src="${d.img}" onerror="this.parentNode.innerHTML='<span>${name[0]}</span>'">`;
                // let imgContent = `<span>${name[0]}</span>`;

                avatarsHtml += `
                    <div class="avatar-wrapper">
                        <div class="mini-avatar">${imgContent}</div>
                        ${costBadge}${wuwuwuBadge}${timesBadge}
                    </div>`;
            });

            // 使用 Grid 布局的数据展示，手机端分两列
            row.innerHTML = `
                <div class="team-avatars">${avatarsHtml}</div>
                <div class="result-info">
                    <div class="info-item">
                        <span class="info-label">目标</span> 
                        <span class="moves-badge">${r.moves} 动</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">金数</span> <span class="info-val">${r.cost}</span>
                        <span class="info-label">速度</span> 
                        <span class="info-val" style="color:#2563eb;">${r.speed.toFixed(1)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">拉条</span> <span>${(r.advancePct * 100).toFixed(0)}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">速加</span> <span>${(r.spdPct * 100).toFixed(0)}%</span>
                    </div>
                </div>
            `;
            resultsArea.appendChild(row);
        });
    }

    // --- 4. 导出逻辑 (关键优化) ---
    function exportImage() {
        const captureArea = document.getElementById('capture-area');
        
        // 1. 添加 .capture-mode 类，强制应用桌面端布局样式
        captureArea.classList.add('capture-mode');
        
        // 2. 临时调整背景，防止透明
        const originalBg = captureArea.style.background;
        captureArea.style.background = "#fff";

        // 3. 开始截图
        html2canvas(captureArea, {
            scale: 2, // 2倍清晰度
            useCORS: true,
        }).then(canvas => {
            // 4. 恢复样式
            captureArea.classList.remove('capture-mode');
            captureArea.style.background = originalBg;

            // 5. 下载
            const link = document.createElement('a');
            link.download = 'firefly_calc_result.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("生成图片失败，请刷新重试");
            captureArea.classList.remove('capture-mode');
        });
    }

    initUI();
</script>

</body>
</html>